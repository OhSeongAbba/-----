<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미래 직업 탐험대</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', 'Noto Sans KR', sans-serif;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow-y: auto;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            color: #4a4a4a;
            border-radius: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .input-box, .select-box, .textarea-box {
            border: 3px solid #667eea;
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            color: #4a4a4a;
        }
        .input-box:focus, .select-box:focus, .textarea-box:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.3);
            outline: none;
        }
        .button-start, .button-submit, .button-ai-interview, .button-next {
            background: linear-gradient(45deg, #FF6B6B, #FFC94A);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .button-submit {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        .button-ai-interview {
            background: linear-gradient(45deg, #667eea, #3B82F6);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .button-next {
            background: linear-gradient(45deg, #667eea, #3B82F6);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .button-start:hover, .button-submit:hover, .button-ai-interview:hover, .button-next:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.6);
        }
        .button-start:active, .button-submit:active, .button-ai-interview:active, .button-next:active {
            transform: translateY(1px);
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }
        .bouncing-text {
            animation: bounce 2s infinite;
        }
        .stage-title {
            color: #764ba2;
        }
        .loading-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: .2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: .4s;
        }
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        .mic-wave {
            display: inline-block;
            width: 2px;
            height: 10px;
            background-color: #667eea;
            margin: 0 1px;
            animation: wave 1s infinite ease-in-out;
            border-radius: 1px;
        }
        .mic-wave:nth-child(2) { animation-delay: 0.1s; }
        .mic-wave:nth-child(3) { animation-delay: 0.2s; }
        .mic-wave:nth-child(4) { animation-delay: 0.3s; }
        .mic-wave:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 20px; }
        }
        .ranking-item {
            background-color: #f3f4f6;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .ranking-item.self {
            background-color: #d1e7dd;
            border: 2px solid #4CAF50;
        }
        .rank-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #764ba2;
            width: 3rem;
            text-align: center;
        }
        .rank-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin-left: auto;
        }
    </style>
</head>
<body class="font-jua text-white">
    <!-- Screen Container -->
    <div id="screen-container">
        <!-- 0단계: 마이크 테스트 & 권한 요청 -->
        <div id="mic-check-screen" class="card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 stage-title">
                0단계 | 마이크 점검
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-6">
                AI 면접을 시작하기 전에 마이크가 잘 작동하는지 확인해 볼까요? <br>
                아래 버튼을 누르면 마이크 사용 권한 요청이 나타날 거예요.
            </p>
            <div id="mic-status-display" class="bg-gray-200 p-6 rounded-xl mb-8 shadow-inner text-lg md:text-xl">
                <p id="mic-status-text" class="text-gray-600">
                    마이크 상태: 대기 중...
                </p>
                <div id="mic-test-visual" class="flex justify-center items-end h-10 mt-4"></div>
            </div>
            <button id="micCheckButton" class="button-submit w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95">
                🎤 마이크 테스트하기!
            </button>
        </div>

        <!-- 시작 화면 (초기 숨김) -->
        <div id="start-screen" class="hidden card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto transform transition-all hover:scale-105 duration-500">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600 drop-shadow-lg bouncing-text">
                미래 직업 탐험대
            </h1>
            <h2 class="text-xl sm:text-2xl md:text-3xl font-semibold mb-6 text-gray-700">
                이력서 작성 & AI 면접!
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-8">
                친구들, 미래의 전문가가 될 준비됐나요? <br>
                내 손으로 직접 이력서도 작성해 보고, AI 면접관과 함께 멋진 직업도 찾으러 떠나봐요!
                지금 바로 여러분의 코드를 입력하고 모험을 시작해요!
            </p>
            <div class="mb-8">
                <input type="text" id="teamCodeInput" placeholder="우리 팀 코드를 입력해 줘!" class="input-box w-full max-w-xs text-lg md:text-xl text-center font-sans tracking-wide">
            </div>
            <button id="startButton" class="button-start text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95">
                🚀 모험 시작하기!
            </button>
        </div>

        <!-- 1단계: 직업/회사 선택 & 이력서 작성 (초기 숨김) -->
        <div id="job-selection-screen" class="hidden card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 stage-title">
                1단계 | 직업 탐색
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-6">
                당신이 꿈꾸는 미래 직업을 선택하고, 어떤 회사에 지원할 수 있는지 알아볼까요?
            </p>
            <div class="mb-6">
                <label for="job-select" class="block text-lg sm:text-xl font-bold mb-2 text-gray-700">탐험하고 싶은 직업을 골라볼까?</label>
                <select id="job-select" class="select-box w-full text-lg sm:text-xl text-center">
                    <option value="">-- 직업을 선택해 주세요 --</option>
                    <option value="개발자">개발자 (코드 마법사)</option>
                    <option value="디자이너">디자이너 (창의력 대장)</option>
                    <option value="마케터">마케터 (아이디어 천재)</option>
                    <option value="과학자">과학자 (호기심 박사)</option>
                    <option value="요리사">요리사 (맛의 예술가)</option>
                    <option value="의사">의사 (치료의 히어로)</option>
                </select>
            </div>
            
            <button id="nextStepButton" class="button-next w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95 mt-8 hidden">
                다음 단계로!
            </button>
        </div>

        <!-- 1-2단계: 회사 인재상 페이지 (초기 숨김) -->
        <div id="company-info-screen" class="hidden card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 stage-title">
                1단계 | 인재상 알아보기
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-6" id="company-intro-text">
                <span id="selected-job-info"></span> 직업의 회사들을 살펴볼까요?
            </p>
            <div id="company-list-area" class="mb-6">
                <!-- 회사 목록이 동적으로 추가됩니다 -->
            </div>
            <button id="goToResumeButton" class="button-submit w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95 mt-8 hidden">
                💌 이력서 작성하러 가기!
            </button>
        </div>


        <!-- 1-3단계: 이력서 작성 페이지 (초기 숨김) -->
        <div id="resume-form-screen" class="hidden card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 stage-title">
                1단계 | 이력서 작성
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-6">
                선택한 회사에 맞는 멋진 이력서를 만들어 볼까요?
            </p>
            <form id="resume-form" class="text-left">
                <div class="mb-4">
                    <label for="name" class="block text-lg font-bold mb-2 text-gray-700">이름이 뭐예요? ✨</label>
                    <input type="text" id="name" class="input-box w-full" placeholder="내 이름을 멋지게 써 주세요!">
                </div>
                <div class="mb-4">
                    <label for="selected-job" class="block text-lg font-bold mb-2 text-gray-700">선택한 직업</label>
                    <input type="text" id="selected-job-resume" class="input-box w-full bg-gray-200" readonly>
                </div>
                <div class="mb-4">
                    <label for="selected-company" class="block text-lg font-bold mb-2 text-gray-700">지원 회사</label>
                    <input type="text" id="selected-company-resume" class="input-box w-full bg-gray-200" readonly>
                </div>
                <div class="mb-4">
                    <label for="strengths" class="block text-lg font-bold mb-2 text-gray-700">내가 가진 특별한 능력은? 💪</label>
                    <textarea id="strengths" class="textarea-box w-full h-24" placeholder="이 직업에 꼭 필요한 나만의 강점을 마음껏 자랑해 주세요!"></textarea>
                </div>
                <div class="mb-4">
                    <label for="special-experience" class="block text-lg font-bold mb-2 text-gray-700">나의 특별한 경험! 🌟</label>
                    <textarea id="special-experience" class="textarea-box w-full h-24" placeholder="자격증이나 특별한 활동 경험, 대회 수상 경력 등을 적어 보세요!"></textarea>
                </div>
                <div class="mb-6">
                    <label for="motivation" class="block text-lg font-bold mb-2 text-gray-700">이 직업을 선택한 이유는? 🤔</label>
                    <textarea id="motivation" class="textarea-box w-full h-24" placeholder="왜 이 직업이 멋져 보이는지 솔직하게 이야기해 주세요!"></textarea>
                </div>
                
                <div class="mt-8">
                    <button id="analyzeStrengthsButton" class="w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95" style="background: linear-gradient(45deg, #10B981, #34D399);">
                        ✨ 이력서 강점 분석하기
                    </button>
                    <div id="strength-analysis-area" class="mt-4 bg-gray-200 p-6 rounded-xl text-left text-lg md:text-xl hidden">
                        <h3 class="font-bold text-gray-700 mb-2">AI가 분석한 나의 강점</h3>
                        <div id="strength-analysis-text" class="text-gray-800"></div>
                    </div>
                </div>

                <div id="submitButtonContainer" class="mt-6 hidden">
                     <button id="submitResumeButton" type="submit" class="button-submit w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95">
                        💌 이력서 제출하고 다음 단계로!
                    </button>
                </div>
            </form>
        </div>


        <!-- 2단계: AI 면접 화면 (초기 숨김) -->
        <div id="ai-interview-screen" class="hidden card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 stage-title">
                2단계 | AI 면접관과 대화하기
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-6" id="interview-intro">
                AI 면접관을 만나 볼 시간이에요! 아래 '면접 시작하기' 버튼을 눌러주세요.
            </p>
            <div class="bg-gray-200 p-6 rounded-xl mb-6 shadow-inner text-left text-lg md:text-xl">
                <h3 class="font-bold text-gray-700 mb-2">AI 면접관의 질문</h3>
                <div id="ai-question" class="text-gray-800">
                    면접관을 불러오는 중...
                </div>
            </div>
            <div class="bg-blue-100 p-6 rounded-xl mb-8 shadow-inner text-left text-lg md:text-xl">
                <h3 class="font-bold text-blue-700 mb-2">나의 답변</h3>
                <textarea id="my-answer-text" class="textarea-box w-full h-24 font-sans tracking-wide text-gray-800" placeholder="여기에 답변을 작성해 보세요."></textarea>
            </div>
            <div id="feedback-area" class="bg-green-100 p-6 rounded-xl mb-8 shadow-inner text-left text-lg md:text-xl hidden">
                <h3 class="font-bold text-green-700 mb-2">AI 면접관의 피드백 📝</h3>
                <div id="feedback-text" class="text-green-800"></div>
            </div>
            <button id="interviewStartButton" class="button-ai-interview w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95">
                🎙️ 면접 시작하기
            </button>
            <button id="micButton" class="button-ai-interview w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95 hidden">
                🎙️ 답변하기
            </button>
            <div id="mic-status" class="mt-4 text-sm font-semibold text-red-500 hidden">
                마이크가 켜졌습니다. 질문을 듣고 답변해 주세요.
            </div>
        </div>

        <!-- 3단계: 랭킹 화면 (초기 숨김) -->
        <div id="ranking-screen" class="hidden card p-8 sm:p-12 md:p-16 text-center max-w-2xl mx-auto">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 stage-title">
                3단계 | 전문가 면접 점수 발표!
            </h2>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed mb-6">
                면접을 통해 얻은 점수를 확인해 볼까요?
            </p>
            <div class="bg-blue-100 p-6 rounded-xl mb-8 shadow-inner text-left text-lg md:text-xl">
                <h3 class="font-bold text-blue-700 mb-2">나의 점수</h3>
                <div id="my-scores" class="text-blue-800">
                    <p>이력서 점수: <span id="resume-score"></span>점</p>
                    <p>면접 점수: <span id="interview-score"></span>점</p>
                </div>
            </div>
            <div id="ranking-list" class="space-y-4 text-left hidden">
                <!-- 랭킹 아이템이 여기에 동적으로 추가됩니다 -->
            </div>
             <!-- ✨ New feature: Team Mission Generation -->
            <div class="mt-8">
                <button id="generateMissionButton" class="w-full text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl md:text-3xl shadow-lg transform active:scale-95" style="background: linear-gradient(45deg, #FF6B6B, #FFC94A);">
                    ✨ 우리 팀만의 미션 만들기!
                </button>
                <div id="mission-area" class="mt-4 bg-gray-200 p-6 rounded-xl text-left text-lg md:text-xl hidden">
                    <h3 class="font-bold text-gray-700 mb-2">오늘의 협력 미션</h3>
                    <div id="mission-text" class="text-gray-800"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        // ✅ 여기에 복사한 Firebase 프로젝트 정보를 붙여넣으세요.
        // const firebaseConfig = { ... };
        const firebaseConfig = {
            apiKey: "AIzaSyAMlZRQtZBUwe29UxWvoCk9eyBV3bWfTAs",
            authDomain: "미래직업탐험대.firebaseapp.com",
            projectId: "미래직업탐험대",
            storageBucket: "미래직업탐험대.appspot.com",
            messagingSenderId: "367246231268",
            appId: "1:367246231268:web:1234567890abcdef"
        };
        
        const appId = firebaseConfig.projectId;
        const initialAuthToken = null;

        let db = null;
        let auth = null;
        let userId = null;

        let recognition = null;
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let currentQuestionIndex = 0;
        let micPermissionGranted = false;
        let selectedCompanyInfo = null;

        const companyInfo = {
            "개발자": {
                companies: ["코드랩", "앱스타"],
                "코드랩": "코드랩은 재미있는 게임과 앱을 만드는 회사예요. 새로운 도전을 좋아하고, 친구들과 함께 멋진 코딩 프로젝트를 만들고 싶은 사람을 찾고 있어요!",
                "앱스타": "앱스타는 사람들이 더 편리하게 생활할 수 있는 스마트한 앱을 만드는 곳이에요. 평소에 불편했던 점을 찾아내서 해결하는 것에 관심이 많은 사람을 기다리고 있어요."
            },
            "디자이너": {
                companies: ["아름다운 디자인", "크리에이티브 스튜디오"],
                "아름다운 디자인": "아름다운 디자인은 사람들에게 행복을 주는 그림과 캐릭터를 만들어요. 상상력이 풍부하고, 자신의 생각을 그림으로 표현하는 것을 좋아하는 사람을 찾고 있어요.",
                "크리에이티브 스튜디오": "크리에이티브 스튜디오는 멋진 포스터와 웹사이트를 만드는 회사예요. 다른 사람들에게 특별한 메시지를 전달하는 디자인을 만들고 싶은 사람에게 딱 맞는 곳이에요."
            },
            "마케터": {
                companies: ["아이디어 연구소", "브랜드메이커"],
                "아이디어 연구소": "아이디어 연구소는 반짝이는 아이디어를 모아 새로운 제품을 성공시키는 곳이에요. 호기심이 많고, 사람들의 마음을 움직이는 방법을 잘 아는 사람을 찾고 있어요.",
                "브랜드메이커": "브랜드메이커는 회사나 상품의 멋진 이미지를 만들어주는 전문가들이 모인 곳이에요. 사람들이 어떤 것에 관심이 있는지 잘 관찰하고, 재미있는 이야기를 만드는 것을 좋아하는 사람을 기다리고 있어요."
            },
            "과학자": {
                companies: ["미래 과학 연구소", "스페이스랩"],
                "미래 과학 연구소": "미래 과학 연구소는 세상의 문제를 해결할 새로운 과학 기술을 연구해요. 왜 그럴까? 어떻게 될까? 같은 질문을 자주 하는 호기심쟁이를 찾고 있어요.",
                "스페이스랩": "스페이스랩은 우주를 탐험하고 새로운 행성을 찾는 연구를 해요. 밤하늘의 별을 보며 우주를 상상하는 것을 좋아하는 사람을 기다리고 있어요."
            },
            "요리사": {
                companies: ["맛있는 키친", "행복한 빵집"],
                "맛있는 키친": "맛있는 키친은 사람들에게 최고의 맛을 선물하는 요리사들이 모인 곳이에요. 여러 가지 재료를 조합하여 새로운 맛을 내는 것을 좋아하는 사람을 찾고 있어요.",
                "행복한 빵집": "행복한 빵집은 사람들의 기분을 좋게 만드는 달콤한 빵을 만들어요. 반죽을 만지고, 빵이 부풀어 오르는 과정을 지켜보는 것을 좋아하는 사람을 기다리고 있어요."
            },
            "의사": {
                companies: ["밝은 병원", "친절한 의료센터"],
                "밝은 병원": "밝은 병원은 환자들이 아프지 않고 건강하게 지낼 수 있도록 도와주는 곳이에요. 다른 사람을 보살피고, 힘든 친구를 보면 도와주고 싶은 마음이 드는 사람을 찾고 있어요.",
                "친절한 의료센터": "친절한 의료센터는 환자들의 마음까지 보듬어주는 것을 중요하게 생각해요. 따뜻한 마음으로 사람들을 위로하고, 건강에 대한 지식을 배우는 것을 좋아하는 사람에게 딱 맞는 곳이에요."
            }
        };

        const companyQuestions = {
            "개발자": {
                "코드랩": [
                    "코드랩에 지원한 이유는 무엇인가요? 저희 회사가 만드는 게임에 대해 아는 것이 있나요?",
                    "새로운 코딩 기술을 배우는 나만의 방법은 무엇인가요? 예를 들어 설명해 주세요.",
                    "친구와 함께 코딩 프로젝트를 해본 경험이 있나요? 가장 재미있었던 프로젝트는 무엇이었나요?",
                    "만약 컴퓨터가 말을 듣지 않는다면, 어떻게 문제를 해결해 볼 건가요?",
                    "가장 좋아하는 게임은 무엇이고, 그 게임을 직접 만든다면 어떤 새로운 기능을 추가하고 싶나요?"
                ],
                "앱스타": [
                    "앱스타에 지원한 이유는 무엇인가요?",
                    "가장 좋아하는 앱은 무엇이며, 왜 좋아하는지 말해볼까요?",
                    "평소에 스마트폰을 어떻게 사용하는지 말해줄 수 있나요? 더 편리하게 만들고 싶은 점이 있나요?",
                    "사람들이 불편해하는 점을 찾아내서 앱으로 해결하고 싶은 아이디어가 있나요?",
                    "친구들과 재미있는 아이디어를 공유하는 나만의 방법은 무엇인가요?"
                ]
            },
            "디자이너": {
                "아름다운 디자인": [
                    "아름다운 디자인에 지원한 이유는 무엇인가요?",
                    "가장 좋아하는 색깔 조합은 무엇이며, 그 이유는 무엇인가요?",
                    "자신이 가장 좋아하는 캐릭터를 그려본 적이 있나요? 어떻게 그렸는지 설명해 주세요.",
                    "만약 모든 색깔을 한 가지만 써야 한다면, 어떤 색을 고르고 왜 그 색을 고를 건가요?",
                    "가장 기억에 남는 간판이나 포스터는 무엇이며, 왜 기억에 남았는지 말해주세요."
                ],
                "크리에이티브 스튜디오": [
                    "크리에이티브 스튜디오에 지원한 이유는 무엇인가요?",
                    "만약 우리 학교의 자랑거리를 소개하는 포스터를 만든다면, 어떤 내용을 넣고 싶나요?",
                    "사람들이 행복하게 해줄 수 있는 디자인은 무엇이라고 생각하나요?",
                    "디자인 작업을 할 때 가장 중요하게 생각하는 점은 무엇인가요?",
                    "어려운 주제를 다른 사람에게 쉽게 설명하기 위해 디자인을 어떻게 활용할 수 있을까요?"
                ]
            },
            "마케터": {
                "아이디어 연구소": [
                    "아이디어 연구소에 지원한 이유는 무엇인가요? 저희가 만든 제품 중에 아는 것이 있나요?",
                    "가장 좋아하는 과자를 어떻게 하면 더 많은 친구들에게 알릴 수 있을까요? 재미있는 아이디어를 말해 주세요.",
                    "우리 반의 자랑거리를 소개하는 포스터를 만든다면 어떤 내용을 넣고 싶나요?",
                    "사람들의 마음을 움직이는 광고를 만들려면 무엇이 가장 중요할까요?",
                    "만약 학교 축제를 홍보해야 한다면, 어떤 방법으로 사람들을 모을 건가요?"
                ],
                "브랜드메이커": [
                    "브랜드메이커에 지원한 이유는 무엇인가요?",
                    "사람들이 어떤 것에 관심이 있는지 어떻게 알 수 있을까요?",
                    "친구들에게 자신을 한 단어로 소개한다면 무엇이라고 말할 건가요? 그 이유는요?",
                    "다른 회사의 광고 중에서 가장 재미있다고 생각하는 광고는 무엇인가요? 왜 그런가요?",
                    "자신이 가장 좋아하는 브랜드를 친구에게 소개한다고 상상하고, 그 브랜드의 장점을 3가지 말해 주세요."
                ]
            },
            "과학자": {
                "미래 과학 연구소": [
                    "미래 과학 연구소에 지원한 이유는 무엇인가요? 평소에 과학에 대해 어떤 점이 가장 궁금했나요?",
                    "가장 좋아하는 과학 실험이 있나요? 어떤 실험이었는지, 왜 좋았는지 설명해 주세요.",
                    "세상에서 가장 신기하다고 생각하는 발명품은 무엇인가요? 그 발명품을 더 좋게 만들 아이디어가 있나요?",
                    "만약 타임머신을 만든다면, 언제로 돌아가고 싶나요? 왜 그 시대로 가고 싶은지 말해 주세요.",
                    "지구의 문제를 해결할 새로운 과학 기술을 하나 제안해 볼 수 있나요?"
                ],
                "스페이스랩": [
                    "스페이스랩에 지원한 이유는 무엇인가요?",
                    "만약 우주선에 탈 수 있다면 가장 먼저 가보고 싶은 행성은 어디이고, 왜 그곳에 가고 싶나요?",
                    "우주 탐험을 하려면 어떤 준비를 해야 할까요?",
                    "밤하늘의 별을 보며 우주에 대해 어떤 상상을 해봤나요?",
                    "우주복을 더 안전하고 멋지게 만든다면, 어떤 기능을 추가하고 싶나요?"
                ]
            },
            "요리사": {
                "맛있는 키친": [
                    "맛있는 키친에 지원한 이유는 무엇인가요?",
                    "가장 자신 있는 요리는 무엇이고, 어떻게 만들 수 있나요?",
                    "친구들에게 어떤 음식을 만들어주고 싶나요? 그 이유는 무엇인가요?",
                    "만약 눈에 보이지 않는 재료로 요리를 해야 한다면, 어떤 요리를 만들고 싶나요?",
                    "다른 나라의 요리 중에서 가장 흥미로운 것은 무엇인가요? 그 이유는요?"
                ],
                "행복한 빵집": [
                    "행복한 빵집에 지원한 이유는 무엇인가요?",
                    "가장 좋아하는 빵은 무엇인가요? 그 빵을 어떻게 하면 더 맛있게 만들 수 있을까요?",
                    "손님들에게 어떤 빵을 추천해주고 싶나요? 그 이유는요?",
                    "빵 반죽을 만질 때 어떤 기분이 드나요? 요리 과정에서 가장 좋아하는 부분은 무엇인가요?",
                    "새로운 종류의 빵을 개발한다면, 어떤 재료를 넣고 싶나요?"
                ]
            },
            "의사": {
                "밝은 병원": [
                    "밝은 병원에 지원한 이유는 무엇인가요?",
                    "아픈 친구를 어떻게 위로해줄 수 있을까요?",
                    "환자를 돌보는 것에서 가장 중요하다고 생각하는 것은 무엇인가요?",
                    "만약 세상의 모든 병을 고칠 수 있는 약을 만든다면, 어떤 병을 가장 먼저 고치고 싶나요?",
                    "아픈 사람들에게 힘을 줄 수 있는 한마디를 해 주세요."
                ],
                "친절한 의료센터": [
                    "친절한 의료센터에 지원한 이유는 무엇인가요?",
                    "다른 사람을 도울 때 가장 행복했던 경험은 무엇인가요?",
                    "친구들이 건강하게 지내려면 어떻게 해야 하는지 조언해 줄 수 있나요?",
                    "몸이 아픈 것보다 마음이 아픈 사람을 더 잘 보살피려면 어떻게 해야 할까요?",
                    "건강에 대한 지식을 다른 친구들에게 재미있게 알려줄 방법이 있나요?"
                ]
            }
        };

        let currentQuestions = [];
        
        let userName = '';
        let userJob = '';
        let userCompany = '';
        let finalInterviewScore = 0;
        let finalResumeScore = 0;
        
        document.addEventListener("DOMContentLoaded", async () => {
            const startScreen = document.getElementById('start-screen');
            const micCheckScreen = document.getElementById('mic-check-screen');
            const jobSelectionScreen = document.getElementById('job-selection-screen');
            const companyInfoScreen = document.getElementById('company-info-screen');
            const resumeFormScreen = document.getElementById('resume-form-screen');
            const aiInterviewScreen = document.getElementById('ai-interview-screen');
            const hiringResultScreen = document.getElementById('hiring-result-screen');
            const finalScoreScreen = document.getElementById('final-score-screen');


            const startButton = document.getElementById('startButton');
            const micCheckButton = document.getElementById('micCheckButton');
            const nextStepButton = document.getElementById('nextStepButton');
            const goToResumeButton = document.getElementById('goToResumeButton');
            const submitResumeButton = document.getElementById('submitResumeButton');
            const interviewStartButton = document.getElementById('interviewStartButton');
            const micButton = document.getElementById('micButton');
            const teamCodeInput = document.getElementById('teamCodeInput');
            
            const jobSelect = document.getElementById('job-select');
            const selectedJobInfoSpan = document.getElementById('selected-job-info');
            const companyListArea = document.getElementById('company-list-area');

            const nameInput = document.getElementById('name');
            const strengthsInput = document.getElementById('strengths');
            const specialExperienceInput = document.getElementById('special-experience');
            const motivationInput = document.getElementById('motivation');
            const selectedJobResumeInput = document.getElementById('selected-job-resume');
            const selectedCompanyResumeInput = document.getElementById('selected-company-resume');

            const submitButtonContainer = document.getElementById('submitButtonContainer');

            const micStatusText = document.getElementById('mic-status-text');
            const micTestVisual = document.getElementById('mic-test-visual');
            const aiQuestionDiv = document.getElementById('ai-question');
            const myAnswerTextarea = document.getElementById('my-answer-text');
            const feedbackArea = document.getElementById('feedback-area');
            const feedbackText = document.getElementById('feedback-text');
            const micStatus = document.getElementById('mic-status');
            const analyzeStrengthsButton = document.getElementById('analyzeStrengthsButton');
            const strengthAnalysisArea = document.getElementById('strength-analysis-area');
            const strengthAnalysisText = document.getElementById('strength-analysis-text');
            const finalResultButton = document.getElementById('final-result-button');
            const myResumeScoreSpan = document.getElementById('final-resume-score');
            const myInterviewScoreSpan = document.getElementById('final-interview-score');
            const resumeScoreReasonDiv = document.getElementById('resume-score-reason');
            const interviewScoreReasonDiv = document.getElementById('interview-score-reason');


            // --- Firebase Initialization and Auth ---
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                } else {
                    console.warn("Firebase config not found. Firestore features will be disabled.");
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }

            // --- Screen Transition Function ---
            function showScreen(screenId) {
                document.querySelectorAll('#screen-container > div').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }

            // --- Mic Check Logic (Initial Screen) ---
            micCheckButton.addEventListener('click', () => {
                micCheckButton.disabled = true;
                micStatusText.textContent = "마이크 권한을 요청 중입니다...";
                micTestVisual.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            micPermissionGranted = true;
                            micStatusText.textContent = "마이크가 연결되었습니다! 이제 다음 단계로 갈 수 있어요.";
                            micTestVisual.innerHTML = `<div class="mic-wave"></div><div class="mic-wave"></div><div class="mic-wave"></div><div class="mic-wave"></div><div class="mic-wave"></div>`;
                            micCheckButton.textContent = '✔️ 다음 단계로!';
                            micCheckButton.disabled = false;
                            
                            mediaStream = stream;
                            audioContext = new AudioContext();
                            analyser = audioContext.createAnalyser();
                            const source = audioContext.createMediaStreamSource(stream);
                            source.connect(analyser);
                            analyser.fftSize = 256;
                            const dataArray = new Uint8Array(analyser.frequencyBinCount);

                            function updateVisual() {
                                if (!micCheckScreen.classList.contains('hidden')) {
                                    analyser.getByteFrequencyData(dataArray);
                                    const waves = micTestVisual.querySelectorAll('.mic-wave');
                                    let sum = 0;
                                    for(let i=0; i<dataArray.length; i++) { sum += dataArray[i]; }
                                    const average = sum / dataArray.length;
                                    const scale = Math.min(1.5, Math.max(0.5, average / 100));
                                    waves.forEach(wave => {
                                        wave.style.transform = `scaleY(${scale})`;
                                    });
                                }
                                requestAnimationFrame(updateVisual);
                            }
                            updateVisual();

                            micCheckButton.removeEventListener('click', () => {});
                            micCheckButton.addEventListener('click', () => {
                                stream.getTracks().forEach(track => track.stop());
                                showScreen('start-screen');
                            });
                        })
                        .catch(err => {
                            micStatusText.textContent = "마이크 연결에 실패했습니다. 권한을 허용했는지 확인해 주세요. 😭";
                            micTestVisual.innerHTML = '';
                            micCheckButton.textContent = '다시 시도하기';
                            micCheckButton.disabled = false;
                            console.error("마이크 접근 거부:", err);
                        });
                } else {
                    micStatusText.textContent = "이 브라우저에서는 마이크 기능을 지원하지 않습니다. 최신 크롬 브라우저를 사용해 주세요.";
                    micTestVisual.innerHTML = '';
                    micCheckButton.disabled = true;
                }
            });

            // --- Start Button Click Event ---
            startButton.addEventListener('click', () => {
                showScreen('job-selection-screen');
            });

            // --- Job Selection Dropdown Change Event ---
            jobSelect.addEventListener('change', (event) => {
                const selectedJob = event.target.value;
                if(selectedJob) {
                    nextStepButton.classList.remove('hidden');
                } else {
                    nextStepButton.classList.add('hidden');
                }
            });

            // --- Next Step Button Click Event (after job selection) ---
            nextStepButton.addEventListener('click', () => {
                userJob = jobSelect.value;
                selectedJobInfoSpan.textContent = userJob;
                companyListArea.innerHTML = ''; // Clear previous companies
                goToResumeButton.classList.add('hidden');

                const companies = companyInfo[userJob].companies;
                companies.forEach(company => {
                    const companyCard = document.createElement('div');
                    companyCard.className = 'card p-6 rounded-xl text-left mb-4 cursor-pointer hover:shadow-xl transition-shadow duration-300';
                    companyCard.innerHTML = `<h3 class="text-xl font-bold">${company}</h3><p class="text-gray-600 mt-2">${companyInfo[userJob][company]}</p>`;
                    companyCard.addEventListener('click', () => {
                        userCompany = company;
                        goToResumeButton.classList.remove('hidden');
                        document.querySelectorAll('#company-list-area .card').forEach(card => card.classList.remove('border-4', 'border-blue-500', 'shadow-lg'));
                        companyCard.classList.add('border-4', 'border-blue-500', 'shadow-lg');
                    });
                    companyListArea.appendChild(companyCard);
                });

                showScreen('company-info-screen');
            });


            goToResumeButton.addEventListener('click', () => {
                selectedJobResumeInput.value = userJob;
                selectedCompanyResumeInput.value = userCompany;
                showScreen('resume-form-screen');
            });

            // --- Resume Submit & Save Data ---
            submitResumeButton.addEventListener('click', (event) => {
                event.preventDefault();
                userName = nameInput.value;
                if (!userName) {
                    const messageBox = document.createElement('div');
                    messageBox.className = "fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50";
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                            <p class="text-gray-800 text-lg font-bold mb-4">이름을 입력해주세요!</p>
                            <button class="bg-purple-600 text-white px-6 py-2 rounded-full font-bold">확인</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    messageBox.querySelector('button').addEventListener('click', () => {
                        messageBox.remove();
                    });
                    return;
                }
                showScreen('ai-interview-screen');
            });

            // --- Interview Start Button Click Event ---
            interviewStartButton.addEventListener('click', () => {
                interviewStartButton.classList.add('hidden');
                micButton.classList.remove('hidden');
                startInterviewFlow();
            });

            // --- AI Interview Logic & Data Save ---
            async function getAiFeedback(question, answer, job, company) {
                const apiKey = "AIzaSyAMlZRQtZBUwe29UxWvoCk9eyBV3bWfTAs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `
                    You are a friendly AI interview coach for a 6th-grade student. Your role is to give helpful and positive feedback and a score on their interview answers.
                    - The score must be an integer from 1 to 100 based on the quality of the answer. Higher scores for more detailed, confident, and relevant answers.
                    - The response must be a JSON object with 'feedback' and 'score' properties.
                    - 'feedback' should be a friendly, short sentence of praise, a single-sentence suggestion for improvement, and an encouraging closing.
                    - The tone must be simple and supportive for a 6th grader.
                    - Example JSON: { "feedback": "정말 멋진 대답이에요! 답변에 더 많은 예를 들어보면 더 좋을 것 같아요. 다음 질문도 화이팅!", "score": 85 }
                `;

                const userQuery = `
                    **Interview Question:** "${question}"
                    **Student Answer:** "${answer}"
                    **지원 직업:** ${job}
                    **지원 회사:** ${company}
                    Give me feedback and a score for this answer in a JSON object format.
                `;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return JSON.parse(text);
                    }
                } catch (error) {
                    console.error("AI feedback generation error:", error);
                }
                return { feedback: "피드백을 생성할 수 없어요. 다시 시도해 주세요.", score: 0 };
            }

            async function startInterviewFlow() {
                const jobQuestions = companyQuestions[userJob];
                if (!jobQuestions || !jobQuestions[userCompany]) {
                    aiQuestionDiv.textContent = "죄송합니다. 해당 회사의 면접 질문이 준비되지 않았습니다.";
                    return;
                }
                currentQuestions = jobQuestions[userCompany];

                if (currentQuestionIndex >= currentQuestions.length) {
                    // All questions asked, proceed to show hiring result
                    showFinalResults();
                    return;
                }

                aiQuestionDiv.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
                myAnswerTextarea.value = '';
                feedbackArea.classList.add('hidden');
                feedbackText.textContent = '';
                
                const question = currentQuestions[currentQuestionIndex];
                aiQuestionDiv.textContent = question;
                
                myAnswerTextarea.placeholder = '여기에 답변을 작성해 보세요.';
                micButton.textContent = '🎙️ 답변하기';
                micButton.disabled = false;
            }

            function startRecognition() {
                micButton.disabled = true;
                micStatus.classList.remove('hidden');
                
                if (recognition) {
                    recognition.start();
                } else {
                     if ('webkitSpeechRecognition' in window) {
                        recognition = new webkitSpeechRecognition();
                        recognition.continuous = false;
                        recognition.lang = 'ko-KR';
                        
                        // Use typed text as initial value
                        recognition.onstart = () => {
                            if(myAnswerTextarea.value.length > 0) {
                                myAnswerTextarea.value = myAnswerTextarea.value + ' ';
                            }
                        };

                        recognition.onresult = async (event) => {
                            const transcript = event.results[0][0].transcript;
                            myAnswerTextarea.value = transcript;
                            
                            micStatus.classList.add('hidden');
                            const question = aiQuestionDiv.textContent;
                            const { feedback, score } = await getAiFeedback(question, transcript, userJob, userCompany);
                            finalInterviewScore += score;
                            feedbackArea.classList.remove('hidden');
                            feedbackText.textContent = feedback;
                            micButton.textContent = '다음 질문 받기';
                            micButton.disabled = false;
                            currentQuestionIndex++;
                        };
                        recognition.onend = () => {
                             micStatus.classList.add('hidden');
                             micButton.disabled = false;
                             if(micButton.textContent === '🎙️ 답변하기') {
                                micButton.textContent = '🎙️ 다시 답변하기';
                             }
                        };
                        recognition.start();
                    } else {
                        const messageBox = document.createElement('div');
                        messageBox.className = "fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50";
                        messageBox.innerHTML = `
                            <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                                <p class="text-gray-800 text-lg font-bold mb-4">음성 인식 기능을 사용할 수 없습니다. 최신 크롬 브라우저를 사용해 주세요.</p>
                                <button class="bg-purple-600 text-white px-6 py-2 rounded-full font-bold">확인</button>
                            </div>
                        `;
                        document.body.appendChild(messageBox);
                        messageBox.querySelector('button').addEventListener('click', () => {
                            messageBox.remove();
                        });
                        micButton.disabled = true;
                        micButton.textContent = "지원되지 않음";
                    }
                }
            }

            micButton.addEventListener('click', () => {
                if (micButton.textContent === '다음 질문 받기') {
                    currentQuestionIndex++;
                    startInterviewFlow();
                } else {
                    if (micPermissionGranted) {
                        startRecognition();
                    } else {
                        // Show a message box if mic permission is not granted
                        const messageBox = document.createElement('div');
                        messageBox.className = "fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50";
                        messageBox.innerHTML = `
                            <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                                <p class="text-gray-800 text-lg font-bold mb-4">마이크 권한이 허용되지 않았습니다.<br>마이크 테스트 화면에서 먼저 권한을 허용해 주세요.</p>
                                <button class="bg-purple-600 text-white px-6 py-2 rounded-full font-bold">확인</button>
                            </div>
                        `;
                        document.body.appendChild(messageBox);
                        messageBox.querySelector('button').addEventListener('click', () => {
                            messageBox.remove();
                        });
                    }
                }
            });

            // --- Firestore Functions ---
            async function saveUserData(name, job, company, interviewScore, motivation, strengths, specialExperience, resumeScore) {
                if (!db || !userId) {
                    console.error("Firestore is not initialized.");
                    return;
                }
                const teamCode = teamCodeInput.value.trim() || 'default-team';
                const collectionPath = `/artifacts/${appId}/public/data/team_results`;
                try {
                    await addDoc(collection(db, collectionPath), {
                        userId: userId,
                        name: name,
                        job: job,
                        company: company,
                        interviewScore: interviewScore,
                        resumeScore: resumeScore,
                        motivation: motivation,
                        strengths: strengths,
                        specialExperience: specialExperience,
                        team: teamCode,
                        timestamp: new Date()
                    });
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }

            async function showFinalResults() {
                showScreen('hiring-result-screen');
                
                const hiringStatusArea = document.getElementById('hiring-status-area');
                const hiringStatusText = document.getElementById('hiring-status-text');
                const scoreDetailsArea = document.getElementById('score-details-area');
                const resumeScoreText = document.getElementById('resume-score-text');
                const interviewScoreText = document.getElementById('interview-score-text');

                // Generate hiring decision based on combined score
                const combinedScore = (finalResumeScore + finalInterviewScore) / 2;
                let hiringDecision = '';
                let hiringMessage = '';

                if (combinedScore >= 70) {
                    hiringDecision = '합격!';
                    hiringMessage = `축하해요, ${userName} 전문가님! 여러분의 뛰어난 능력과 열정이 저희 회사가 찾는 인재상과 완벽하게 일치합니다. 저희와 함께 꿈을 펼쳐나가요!`;
                } else {
                    hiringDecision = '불합격';
                    hiringMessage = `아쉽지만, ${userName} 전문가님. 이번에는 함께하지 못하게 되었습니다. 하지만 여러분의 성장 가능성은 무한합니다! 부족했던 점을 보완해서 다시 도전해 보세요. 응원하겠습니다!`;
                }
                
                document.getElementById('final-hiring-status').textContent = hiringDecision;
                document.getElementById('final-hiring-status-text').textContent = hiringMessage;
            }

            finalResultButton.addEventListener('click', async () => {
                showScreen('final-score-screen');
                const resumeScoreText = document.getElementById('resume-score-text');
                const interviewScoreText = document.getElementById('interview-score-text');

                const { feedback: resumeFeedback } = await getResumeScoreFeedback(motivationInput.value, strengthsInput.value, specialExperienceInput.value, userJob);
                const { feedback: interviewFeedback } = await getInterviewScoreFeedback(finalInterviewScore, userJob, userCompany);
                
                document.getElementById('final-resume-score').textContent = finalResumeScore;
                document.getElementById('final-interview-score').textContent = finalInterviewScore;

                resumeScoreText.textContent = resumeFeedback;
                interviewScoreText.textContent = interviewFeedback;

                // Save data to Firebase
                await saveUserData(userName, userJob, userCompany, finalInterviewScore, motivationInput.value, strengthsInput.value, specialExperienceInput.value, finalResumeScore);
            });

            async function getInterviewScoreFeedback(score, job, company) {
                const apiKey = "AIzaSyAMlZRQtZBUwe29UxWvoCk9eyBV3bWfTAs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `
                    You are a professional HR manager. Explain why a 6th-grade student received a specific interview score. The explanation should be a single, positive, and encouraging sentence. The tone should be simple and easy to understand for a child.
                `;
                const userQuery = `
                    **Interview Score:** ${score}
                    **Chosen Job:** ${job}
                    **Chosen Company:** ${company}
                    Based on these details, explain why this score was given in one sentence.
                `;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    return { feedback: result.candidates?.[0]?.content?.parts?.[0]?.text || "면접 점수 이유를 생성할 수 없어요." };
                } catch (error) {
                    console.error("Interview feedback generation error:", error);
                    return { feedback: "면접 점수 이유를 생성할 수 없어요." };
                }
            }

            async function getResumeScoreFeedback(motivation, strengths, specialExperience, job) {
                const apiKey = "AIzaSyAMlZRQtZBUwe29UxWvoCk9eyBV3bWfTAs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `
                    You are a professional resume analyst. Explain why a 6th-grade student received a specific resume score. The explanation should be a single, positive, and encouraging sentence. The tone should be simple and easy to understand for a child.
                `;
                const userQuery = `
                    **Motivation:** ${motivation}
                    **Strengths:** ${strengths}
                    **Special Experience:** ${specialExperience}
                    **Chosen Job:** ${job}
                    Based on these details, explain the reason for the resume score in one sentence.
                `;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    return { feedback: result.candidates?.[0]?.content?.parts?.[0]?.text || "이력서 점수 이유를 생성할 수 없어요." };
                } catch (error) {
                    console.error("Resume feedback generation error:", error);
                    return { feedback: "이력서 점수 이유를 생성할 수 없어요." };
                }
            }

            // --- Firestore Functions ---
            async function saveUserData(name, job, company, interviewScore, motivation, strengths, specialExperience, resumeScore) {
                if (!db || !userId) {
                    console.error("Firestore is not initialized.");
                    return;
                }
                const teamCode = teamCodeInput.value.trim() || 'default-team';
                const collectionPath = `/artifacts/${appId}/public/data/team_results`;
                try {
                    await addDoc(collection(db, collectionPath), {
                        userId: userId,
                        name: name,
                        job: job,
                        company: company,
                        interviewScore: interviewScore,
                        resumeScore: resumeScore,
                        motivation: motivation,
                        strengths: strengths,
                        specialExperience: specialExperience,
                        team: teamCode,
                        timestamp: new Date()
                    });
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }

            async function showRanking() {
                showScreen('ranking-screen');
            }

            // --- ✨ New Gemini Features ---
            async function getResumeScore(strengths, motivation, specialExperience, job) {
                const apiKey = "AIzaSyAMlZRQtZBUwe29UxWvoCk9eyBV3bWfTAs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `
                    You are a professional resume analyst. Your task is to evaluate a 6th grader's resume strengths and motivation for their chosen job. Based on the relevance and detail, assign a score from 1 to 100. The score must be an integer. The response must be a JSON object with 'feedback' and 'score' properties.
                    - 'feedback' should be a friendly, short sentence of praise, and a single-sentence suggestion for improvement.
                    - The tone must be simple and supportive.
                    - Example JSON: { "feedback": "지원 동기가 매우 구체적이라서 좋아요! 강점에 대한 경험을 더 자세히 적으면 완벽할 것 같아요.", "score": 90 }
                `;
                const userQuery = `
                    **강점:** ${strengths}
                    **특별한 경험:** ${specialExperience}
                    **지원 동기:** ${motivation}
                    **선택 직업:** ${job}
                    위 정보를 바탕으로 이력서 점수를 1-100점 사이로 매겨주고, 피드백을 JSON 객체 형식으로 알려줘.
                `;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return JSON.parse(text);
                    }
                } catch (error) {
                    console.error("Resume score analysis error:", error);
                }
                return { feedback: "점수 분석에 실패했어요.", score: 0 };
            }

            analyzeStrengthsButton.addEventListener('click', async (event) => {
                event.preventDefault(); // Prevent form submission
                const strengths = strengthsInput.value;
                const specialExperience = specialExperienceInput.value;
                const motivation = motivationInput.value;
                const job = selectedJobResumeInput.value; // Use the value from the resume screen
                if (!strengths || !motivation || !job) {
                    strengthAnalysisText.textContent = '강점, 동기, 직업을 모두 입력해야 분석할 수 있어요!';
                    strengthAnalysisArea.classList.remove('hidden');
                    return;
                }
                analyzeStrengthsButton.textContent = '분석 중...';
                analyzeStrengthsButton.disabled = true;
                strengthAnalysisArea.classList.remove('hidden');
                strengthAnalysisText.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
                submitButtonContainer.classList.add('hidden'); // Hide submit button while analyzing

                const { feedback, score } = await getResumeScore(strengths, motivation, specialExperience, job);
                finalResumeScore = score;
                strengthAnalysisText.textContent = `${feedback}`; // Do not show score here

                analyzeStrengthsButton.textContent = '✨ 이력서 강점 분석하기';
                analyzeStrengthsButton.disabled = false;
                submitButtonContainer.classList.remove('hidden'); // Show submit button after analysis
            });

            generateMissionButton.addEventListener('click', async () => {
                generateMissionButton.textContent = '미션 생성 중...';
                generateMissionButton.disabled = true;
                missionArea.classList.remove('hidden');
                missionText.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';

                const teamCode = teamCodeInput.value.trim() || 'default-team';
                const collectionPath = `/artifacts/${appId}/public/data/team_results`;
                
                let teamMembers = [];
                try {
                    const q = query(collection(db, collectionPath), where("team", "==", teamCode));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        teamMembers.push({ name: data.name, job: data.job, interviewScore: data.interviewScore, resumeScore: data.resumeScore });
                    });
                } catch (e) {
                    console.error("Error fetching team members:", e);
                }

                const teamInfo = teamMembers.map(member => `${member.job} ${member.name}`).join(', ');

                const apiKey = "AIzaSyAMlZRQtZBUwe29UxWvoCk9eyBV3bWfTAs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `
                    You are an inspiring game master for a 6th-grade class. Your task is to create a fun, collaborative mission for a team of students based on their chosen future jobs. The mission should require them to work together and use their unique skills. The output should be a single, short paragraph describing the mission.
                `;
                const userQuery = `
                    **Team Members and Jobs:** ${teamInfo}
                    위 정보를 바탕으로 팀원들이 협력해서 해결할 수 있는 재미있는 미션을 만들어 줘.
                `;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    const mission = result.candidates?.[0]?.content?.parts?.[0]?.text || "미션 생성에 실패했어요. 다시 시도해 주세요.";
                    missionText.textContent = mission;
                } catch (error) {
                    console.error("Mission generation error:", error);
                    missionText.textContent = "미션 생성 중 오류가 발생했어요. 다시 시도해 주세요.";
                } finally {
                    generateMissionButton.textContent = '✨ 우리 팀만의 미션 만들기!';
                    generateMissionButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
